{% extends 'books/base.html' %}

{% block title %}Каталог книг - Librio{% endblock %}

{% block content %}
<h1>Каталог книг</h1>

<!-- Поиск и фильтры -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <!-- Поиск -->
            <div class="col-md-4">
                <input type="text" name="search" class="form-control"
                       placeholder="Поиск по названию, автору, жанру..."
                       value="{{ search_query }}">
            </div>

            <!-- Фильтр по жанру -->
            <div class="col-md-3">
                <select name="genre" class="form-select">
                    <option value="">Все жанры</option>
                    {% for genre in genres %}
                        {% if genre_filter == genre.name %}
                            <option value="{{ genre.name }}" selected>{{ genre.name }}</option>
                        {% else %}
                            <option value="{{ genre.name }}">{{ genre.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>

            <!-- Фильтр по доступности -->
           <div class="col-md-3">
    <select name="access_level" class="form-select">
        <option value="">Все уровни доступа</option>
        {% if access_level_filter == "free" %}
            <option value="free" selected>Свободный доступ</option>
        {% else %}
            <option value="free">Свободный доступ</option>
        {% endif %}

        {% if access_level_filter == "student" %}
            <option value="student" selected>Для студентов</option>
        {% else %}
            <option value="student">Для студентов</option>
        {% endif %}

        {% if access_level_filter == "premium" %}
            <option value="premium" selected>Премиум доступ</option>
        {% else %}
            <option value="premium">Премиум доступ</option>
        {% endif %}

        {% if access_level_filter == "restricted" %}
            <option value="restricted" selected>Ограниченный доступ</option>
        {% else %}
            <option value="restricted">Ограниченный доступ</option>
        {% endif %}
    </select>
</div>

            <!-- Кнопки -->
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Найти</button>
            </div>
        </form>

        <!-- Сброс фильтров -->
        {% if search_query or genre_filter or availability_filter %}
        <div class="mt-3">
            <a href="{% url 'book_list' %}" class="btn btn-outline-secondary btn-sm">
                Сбросить фильтры
            </a>
            <small class="text-muted ms-2">
                Найдено книг: {{ books.count }}
            </small>
        </div>
        {% endif %}
    </div>
</div>

<!-- Список книг -->
<div class="row">
    {% for book in books %}
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">{{ book.title }}</h5>
                <p class="card-text">
                    <strong>Автор:</strong> {{ book.author.full_name }}<br>
                    <strong>Жанр:</strong> {{ book.genre.name }}<br>

                    <!-- Уровень доступа -->
                    {% if book.access_level != 'free' %}
                    <strong>Уровень доступа:</strong>
                    <span class="badge
                        {% if book.access_level == 'student' %}bg-warning
                        {% elif book.access_level == 'premium' %}bg-info
                        {% elif book.access_level == 'restricted' %}bg-danger
                        {% else %}bg-secondary{% endif %}">
                        {{ book.get_access_level_display }}
                    </span><br>
                    {% endif %}

                    <!-- Статус доступности -->
                    <strong>Статус:</strong>
                    {% if book.is_available %}
                        <span class="text-success">✅ Доступна для выдачи</span>
                    {% else %}
                        <span class="text-warning">⏳ Выдана (доступ откроется {{ book.get_next_available_date }})</span>
                    {% endif %}
                </p>
            </div>

            <div class="card-footer">
                {% if book.is_available %}
                <a href="{% url 'borrow_book' book.id %}" class="btn btn-primary btn-sm">
                    Выдать книгу
                </a>
                {% else %}
                <span class="btn btn-secondary btn-sm disabled">
                    Недоступна
                </span>
                {% endif %}

                <!-- Информация о сроке выдачи -->
                <small class="text-muted ms-2">
                    {% if book.max_loan_days %}
                    Срок: {{ book.max_loan_days }} дн.
                    {% endif %}
                </small>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="alert alert-info text-center">
            <h4>Книги не найдены</h4>
            <p>
                {% if search_query or genre_filter or availability_filter %}
                Попробуйте изменить параметры поиска или
                <a href="{% url 'book_list' %}">сбросить фильтры</a>
                {% else %}
                В библиотеке пока нет книг.
                <a href="{% url 'admin:books_book_add' %}">Добавьте книги через админку</a>
                {% endif %}
            </p>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Пагинация -->
{% if books.count > 10 %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        <li class="page-item disabled">
            <a class="page-link" href="#">Предыдущая</a>
        </li>
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
            <a class="page-link" href="#">Следующая</a>
        </li>
    </ul>
</nav>
{% endif %}
{% endblock %}